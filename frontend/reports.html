<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700;900&family=Space+Grotesk:wght@400;500;700&display=swap"
  />
  <title>IoT HoneyNet - Analytics & Reports (Updated)</title>
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Socket.IO client (served from backend; preferred to ensure protocol/version match) -->
  <script src="/socket.io/socket.io.js"></script>

  <style>
    /* ensure charts remain responsive */
    canvas { width: 100% !important; height: auto !important; }
  </style>
</head>
<body>
  <div class="relative flex size-full min-h-screen flex-col bg-[#0f241d] dark group/design-root overflow-x-hidden" style='font-family: "Space Grotesk", "Noto Sans", sans-serif;'>
    <div class="layout-container flex h-full grow flex-col">
      <!-- Header with Navigation -->
      <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#204b3d] px-6 sm:px-10 md:px-20 lg:px-28 xl:px-40 py-3">
        <div class="flex items-center gap-4 text-white">
          <div class="size-4" aria-hidden="true">
            <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M36.7273 44C33.9891 44 31.6043 39.8386 30.3636 33.69C29.123 39.8386 26.7382 44 24 44C21.2618 44 18.877 39.8386 17.6364 33.69C16.3957 39.8386 14.0109 44 11.2727 44C7.25611 44 4 35.0457 4 24C4 12.9543 7.25611 4 11.2727 4C14.0109 4 16.3957 8.16144 17.6364 14.31C18.877 8.16144 21.2618 4 24 4C26.7382 4 29.123 8.16144 30.3636 14.31C31.6043 8.16144 33.9891 4 36.7273 4C40.7439 4 44 12.9543 44 24C44 35.0457 40.7439 44 36.7273 44Z"
                fill="currentColor"
              />
            </svg>
          </div>
          <h1 class="text-white text-lg font-bold leading-tight tracking-[-0.015em]">IoT HoneyNet</h1>
        </div>

        <div class="flex flex-1 justify-end gap-8">
          <!-- Main Navigation -->
          <nav class="flex items-center gap-9" aria-label="Main navigation">
            <a href="index.html" class="text-white text-sm font-medium leading-normal hover:text-[#0bda49] transition-colors">Dashboard</a>
            <a href="alerts.html" class="text-white text-sm font-medium leading-normal hover:text-[#0bda49] transition-colors">Live Attacks</a>
            <a href="devices.html" class="text-white text-sm font-medium leading-normal hover:text-[#0bda49] transition-colors">Device Status</a>
            <a href="reports.html" class="text-white text-sm font-medium leading-normal border-b-2 border-[#0bda49] pb-1 transition-colors" aria-current="page">Analytics</a>
          </nav>

          <!-- Export Button -->
          <button
            id="export-report"
            class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-10 bg-[#204b3d] text-white gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5 hover:bg-[#2e6b58] transition-colors"
            aria-label="Export reports"
          >
            <div class="text-white" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                <path d="M224,152v56a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V152a8,8,0,0,1,16,0v56H208V152a8,8,0,0,1,16,0ZM101.66,133.66l24,24a8,8,0,0,0,11.32,0l24-24a8,8,0,0,0-11.32-11.32L136,135.31V40a8,8,0,0,0-16,0v95.31L106.34,122.34a8,8,0,0,0-11.32,11.32Z"/>
              </svg>
            </div>
            <span>Export</span>
          </button>

          <!-- Profile -->
          <div
            class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 cursor-pointer hover:ring-2 hover:ring-[#0bda49] transition-all"
            style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDOpWz02eqvDW64bkSvHYpulpdmyBLbafel4Yj20z3uAA_kjJnTOswd2lS9UCcDORB2SCnW-n3qk-EapQamlPi600-ZUOHeqU3gYcTMVvL366H-KS3NyN4hSKcRt8JBh4mpFfTX0QmsosRZQebJ-Zkv-ePfuDvxOKTetvVmI1OjXWKQVB7sKfWMlwu0QiHkPSju_2PEF2FeNn-93DQDQ9RClMcQTSi4mGwrBUQAibLMOWIKnjXpoeYBhAYQD1ZtF4eWc7pkP-Nxdh8");'
            role="img"
            aria-label="User profile picture"
          />
        </div>
      </header>

      <!-- Main Content -->
      <main class="px-6 sm:px-10 md:px-20 lg:px-28 xl:px-40 flex flex-1 justify-center py-5">
        <div class="layout-content-container flex flex-col max-w-[960px] flex-1">

          <!-- Page Header -->
          <div class="flex flex-wrap justify-between gap-3 p-4">
            <div class="flex items-center gap-4">
              <h1 class="text-white tracking-light text-[32px] font-bold leading-tight min-w-72">Security Analytics</h1>
            </div>
            <div class="flex items-center gap-4">
              <!-- Time Range Selector -->
              <select id="time-range" class="h-8 rounded-xl bg-[#204b3d] text-white text-sm font-medium px-4 pr-8 border-0 cursor-pointer focus:ring-2 focus:ring-[#0bda49]">
                <option value="24h">Last 24 Hours</option>
                <option value="7d" selected>Last 7 Days</option>
                <option value="30d">Last 30 Days</option>
                <option value="90d">Last 90 Days</option>
              </select>
              <div class="flex items-center gap-2 text-sm text-[#8dceb9]">
                <span>Report Generated:</span>
                <span id="report-timestamp" class="font-mono text-[#0bda49]">--:--:--</span>
              </div>
            </div>
          </div>

          <!-- Executive Summary -->
          <section class="px-4 py-3" aria-label="Executive summary">
            <h2 class="text-white text-xl font-bold mb-4">Executive Summary</h2>
            <div class="bg-[#1a2e26] rounded-xl border border-[#2e6b58] p-6 mb-6">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="text-center">
                  <div class="flex items-center justify-center mb-2">
                    <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                    <h3 class="text-[#8dceb9] text-sm font-medium">Threat Level</h3>
                  </div>
                  <p id="threat-level" class="text-white text-2xl font-bold">—</p>
                  <p id="threat-note" class="text-red-400 text-xs">—</p>
                </div>

                <div class="text-center">
                  <div class="flex items-center justify-center mb-2">
                    <div class="w-3 h-3 bg-green-400 rounded-full mr-2"></div>
                    <h3 class="text-[#8dceb9] text-sm font-medium">Blocked Attacks</h3>
                  </div>
                  <p id="blocked-attacks-total" class="text-white text-2xl font-bold">—</p>
                  <p class="text-green-400 text-xs">—</p>
                </div>

                <div class="text-center">
                  <div class="flex items-center justify-center mb-2">
                    <div class="w-3 h-3 bg-yellow-400 rounded-full mr-2"></div>
                    <h3 class="text-[#8dceb9] text-sm font-medium">Active Threats</h3>
                  </div>
                  <p id="active-threats-total" class="text-white text-2xl font-bold">—</p>
                  <p class="text-yellow-400 text-xs">—</p>
                </div>

                <div class="text-center">
                  <div class="flex items-center justify-center mb-2">
                    <div class="w-3 h-3 bg-blue-400 rounded-full mr-2"></div>
                    <h3 class="text-[#8dceb9] text-sm font-medium">System Health</h3>
                  </div>
                  <p id="system-health-total" class="text-white text-2xl font-bold">—</p>
                  <p class="text-green-400 text-xs">—</p>
                </div>
              </div>
            </div>
          </section>

          <!-- Analytics Dashboard Charts -->
          <section class="flex flex-wrap gap-4 px-4 py-6" aria-label="Security analytics dashboard">
            <!-- Attack Types Distribution Chart -->
            <article class="flex min-w-72 flex-1 flex-col gap-2 rounded-xl border border-[#2e6b58] p-6 bg-[#1a2e26]">
              <header>
                <h2 class="text-white text-base font-medium leading-normal">Attack Types Distribution</h2>
                <p id="attack-types-total" class="text-white tracking-light text-[32px] font-bold leading-tight truncate">—</p>
                <div class="flex gap-1">
                  <span class="text-[#8dceb9] text-base font-normal leading-normal">Last 7 Days</span>
                  <span id="attack-types-change" class="text-[#0bda49] text-base font-medium leading-normal">—</span>
                </div>
              </header>

              <div class="mt-4">
                <canvas id="attackTypesCanvas" aria-label="Attack types distribution chart" role="img"></canvas>
              </div>
            </article>

            <!-- Top Attacker Countries Chart -->
            <article class="flex min-w-72 flex-1 flex-col gap-2 rounded-xl border border-[#2e6b58] p-6 bg-[#1a2e26]">
              <header>
                <h2 class="text-white text-base font-medium leading-normal">Top Attacker Countries</h2>
                <p id="attacker-countries-total" class="text-white tracking-light text-[32px] font-bold leading-tight truncate">—</p>
                <div class="flex gap-1">
                  <span class="text-[#8dceb9] text-base font-normal leading-normal">Countries</span>
                  <span id="countries-change" class="text-[#fa5838] text-base font-medium leading-normal">—</span>
                </div>
              </header>

              <div class="mt-4">
                <canvas id="countriesCanvas" aria-label="Top attacker countries chart" role="img"></canvas>
              </div>
            </article>

            <!-- Weekly Attack Growth Chart -->
            <article class="flex min-w-72 flex-1 flex-col gap-2 rounded-xl border border-[#2e6b58] p-6 bg-[#1a2e26]">
              <header>
                <h2 class="text-white text-base font-medium leading-normal">Weekly Attack Growth</h2>
                <p id="weekly-growth-total" class="text-white tracking-light text-[32px] font-bold leading-tight truncate">—</p>
                <div class="flex gap-1">
                  <span class="text-[#8dceb9] text-base font-normal leading-normal">Last 7 Days</span>
                  <span id="growth-trend" class="text-[#0bda49] text-base font-medium leading-normal">—</span>
                </div>
              </header>

              <div class="mt-4">
                <canvas id="weeklyCanvas" aria-label="Weekly attack growth chart" role="img"></canvas>
              </div>
            </article>
          </section>

          <!-- Detailed Attack Analysis -->
          <section class="px-4 py-6">
            <h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] mb-4">Detailed Attack Analysis</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Most Targeted Devices (static summary preserved) -->
              <div class="bg-[#1a2e26] rounded-xl border border-[#2e6b58] p-6">
                <h3 class="text-white text-lg font-semibold mb-4">Most Targeted Devices</h3>
                <div class="space-y-4">
                  <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                      <div class="w-8 h-8 bg-[#204b3d] rounded-lg flex items-center justify-center">
                        📹
                      </div>
                      <span class="text-white">Security Camera</span>
                    </div>
                    <div class="text-right">
                      <div class="text-red-400 font-bold">847</div>
                      <div class="text-xs text-[#8dceb9]">attacks</div>
                    </div>
                  </div>

                  <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                      <div class="w-8 h-8 bg-[#204b3d] rounded-lg flex items-center justify-center">
                        📡
                      </div>
                      <span class="text-white">WiFi Router</span>
                    </div>
                    <div class="text-right">
                      <div class="text-red-400 font-bold">523</div>
                      <div class="text-xs text-[#8dceb9]">attacks</div>
                    </div>
                  </div>

                  <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                      <div class="w-8 h-8 bg-[#204b3d] rounded-lg flex items-center justify-center">
                        🔒
                      </div>
                      <span class="text-white">Smart Lock</span>
                    </div>
                    <div class="text-right">
                      <div class="text-yellow-400 font-bold">234</div>
                      <div class="text-xs text-[#8dceb9]">attempts</div>
                    </div>
                  </div>

                  <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                      <div class="w-8 h-8 bg-[#204b3d] rounded-lg flex items-center justify-center">
                        🌡️
                      </div>
                      <span class="text-white">Smart Thermostat</span>
                    </div>
                    <div class="text-right">
                      <div class="text-green-400 font-bold">98</div>
                      <div class="text-xs text-[#8dceb9]">attempts</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Attack Timeline (dynamic) -->
              <div class="bg-[#1a2e26] rounded-xl border border-[#2e6b58] p-6">
                <h3 class="text-white text-lg font-semibold mb-4">Attack Timeline (Latest)</h3>
                <div id="attack-timeline" class="space-y-3">
                  <!-- rows injected by JS -->
                </div>
              </div>
            </div>
          </section>

          <!-- Recommendations Section -->
          <section class="px-4 py-6">
            <h2 class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] mb-4">Security Recommendations</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="bg-[#2a1810] border border-orange-500/30 rounded-xl p-6">
                <div class="flex items-center gap-3 mb-3">
                  <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center text-white font-bold">!</div>
                  <h3 class="text-orange-400 font-semibold">High Priority</h3>
                </div>
                <p class="text-white text-sm mb-2">Update firmware on Camera #1</p>
                <p class="text-[#8dceb9] text-xs">Vulnerability detected in version 2.1.4</p>
              </div>

              <div class="bg-[#1a2810] border border-yellow-500/30 rounded-xl p-6">
                <div class="flex items-center gap-3 mb-3">
                  <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center text-white font-bold">⚠</div>
                  <h3 class="text-yellow-400 font-semibold">Medium Priority</h3>
                </div>
                <p class="text-white text-sm mb-2">Review router access logs</p>
                <p class="text-[#8dceb9] text-xs">Multiple failed login attempts detected</p>
              </div>

              <div class="bg-[#102818] border border-green-500/30 rounded-xl p-6">
                <div class="flex items-center gap-3 mb-3">
                  <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">ℹ</div>
                  <h3 class="text-green-400 font-semibold">Info</h3>
                </div>
                <p class="text-white text-sm mb-2">Schedule security audit</p>
                <p class="text-[#8dceb9] text-xs">Last audit performed 30 days ago</p>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // Small HTML escape utility to avoid injecting untrusted text into innerHTML
    function escapeHtml(s) {
      return String(s).replace(/[&<>"'`=\/]/g, function (c) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c]);
      });
    }

    // Convert ISO timestamp -> short relative label (UTC-aware)
    function timeAgo(iso) {
      if (!iso) return '--';
      const t = Date.parse(iso);
      if (isNaN(t)) return iso;
      const diff = Date.now() - t;
      const sec = Math.floor(diff / 1000);
      if (sec < 60) return sec + 's ago';
      const min = Math.floor(sec / 60);
      if (min < 60) return min + 'm ago';
      const hr = Math.floor(min / 60);
      if (hr < 24) return hr + 'h ago';
      const days = Math.floor(hr / 24);
      return days + 'd ago';
    }

    // small toast helper
    function flashToast(text, isError=false) {
      const el = document.createElement('div');
      el.className = `fixed right-4 top-4 px-4 py-2 rounded shadow ${isError ? 'bg-red-600' : 'bg-green-600'} z-50`;
      el.textContent = text;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 3000);
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Chart.js instances
      let attackTypesChart = null;
      let countriesChart = null;
      let weeklyChart = null;

      // caches
      let attacksCache = [];

      // timestamp widget
      function updateReportTimestamp() {
        document.getElementById('report-timestamp').textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
      }
      updateReportTimestamp();
      setInterval(updateReportTimestamp, 30000);

      // fetch /api/attacks and populate UI
      async function fetchAndRender() {
        try {
          const res = await fetch('/api/attacks');
          if (!res.ok) throw new Error('/api/attacks returned ' + res.status);
          const data = await res.json();
          // attacks returned in newest-first order by backend; keep that
          attacksCache = data;
          renderTimeline(data);
          updateSummaryAndCharts(data);
        } catch (err) {
          console.error('fetchAndRender error', err);
          flashToast('Failed to load attacks from API (check server)', true);
        }
      }

      // render timeline list
      function renderTimeline(list) {
        const container = document.getElementById('attack-timeline');
        container.innerHTML = '';
        list.slice(0, 50).forEach(item => {
          const country = item.country || '--';
          const method = item.method || 'UNKNOWN';
          const src = escapeHtml(item.source_ip || '--');
          const path = escapeHtml(item.path || '/');
          const time = timeAgo(item.timestamp);
          const severity = escapeHtml(item.severity || '');
          const row = document.createElement('div');
          row.className = 'flex items-center gap-3 p-3 bg-[#204b3d] rounded-lg';
          row.innerHTML = `
            <div class="w-2 h-2 ${severity === 'High' ? 'bg-red-500' : severity === 'Low' ? 'bg-green-400' : 'bg-yellow-400'} rounded-full flex-shrink-0"></div>
            <div class="flex-1 min-w-0">
              <div class="text-white text-sm font-medium">${path}</div>
              <div class="text-[#8dceb9] text-xs">IP: <span class="font-mono">${src}</span> • ${escapeHtml(country)} • ${escapeHtml(method)}</div>
            </div>
            <div class="text-[#8dceb9] text-xs">${time}</div>
          `;
          container.appendChild(row);
        });
      }

      // build charts and summary
      function updateSummaryAndCharts(list) {
        // summary numbers
        document.getElementById('blocked-attacks-total').textContent = (list.length || 0).toLocaleString();
        document.getElementById('active-threats-total').textContent = (list.filter(a => a.severity === 'High').length || 0);
        document.getElementById('system-health-total').textContent = '—';

        const tl = list.length > 200 ? 'Critical' : list.length > 50 ? 'High' : list.length > 10 ? 'Medium' : 'Low';
        document.getElementById('threat-level').textContent = tl;
        document.getElementById('threat-note').textContent = list.length > 50 ? '↑ Increased activity' : 'Stable';

        // Weekly growth (last 7 days)
        const now = new Date();
        const dayLabels = [];
        const dayCounts = [];
        for (let i = 6; i >= 0; i--) {
          const d = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
          d.setUTCDate(d.getUTCDate() - i);
          dayLabels.push(d.toISOString().slice(0, 10));
          dayCounts.push(0);
        }
        list.forEach(a => {
          if (!a.timestamp) return;
          const key = (new Date(a.timestamp)).toISOString().slice(0,10);
          const idx = dayLabels.indexOf(key);
          if (idx !== -1) dayCounts[idx]++;
        });

        // Attack types/methods
        const typeCounts = {};
        list.forEach(a => {
          const t = (a.method || 'UNKNOWN').toUpperCase();
          typeCounts[t] = (typeCounts[t] || 0) + 1;
        });
        const typeLabels = Object.keys(typeCounts).slice(0, 8);
        const typeData = typeLabels.map(l => typeCounts[l]);

        // Countries
        const countryCounts = {};
        list.forEach(a => {
          const c = (a.country || 'Unknown');
          countryCounts[c] = (countryCounts[c] || 0) + 1;
        });
        // sort by count desc and take top 8
        const countriesSorted = Object.entries(countryCounts).sort((a,b)=>b[1]-a[1]).slice(0,8);
        const countryLabels = countriesSorted.map(x => x[0]);
        const countryData = countriesSorted.map(x => x[1]);

        // Update weeklyChart
        const ctxW = document.getElementById('weeklyCanvas').getContext('2d');
        if (weeklyChart) weeklyChart.destroy();
        weeklyChart = new Chart(ctxW, {
          type: 'line',
          data: { labels: dayLabels, datasets: [{ label: 'Attacks', data: dayCounts, fill: true, tension: 0.25 }] },
          options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });

        // Update attackTypesChart
        const ctxT = document.getElementById('attackTypesCanvas').getContext('2d');
        if (attackTypesChart) attackTypesChart.destroy();
        attackTypesChart = new Chart(ctxT, {
          type: 'bar',
          data: { labels: typeLabels, datasets: [{ label: 'Count', data: typeData }] },
          options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });

        // Update countriesChart (horizontal)
        const ctxC = document.getElementById('countriesCanvas').getContext('2d');
        if (countriesChart) countriesChart.destroy();
        countriesChart = new Chart(ctxC, {
          type: 'bar',
          data: { labels: countryLabels, datasets: [{ label: 'Count', data: countryData }] },
          options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true } } }
        });

        // totals
        document.getElementById('attack-types-total').textContent = (list.length || 0).toLocaleString();
        document.getElementById('attacker-countries-total').textContent = Object.keys(countryCounts).length || '0';
        document.getElementById('weekly-growth-total').textContent = ((dayCounts.reduce((a,b)=>a+b,0) || 0) > 0 ? ('+' + Math.round(((dayCounts.reduce((a,b)=>a+b,0) / 7) || 0)) + '%') : '—');
      }

      // Setup Socket.IO
      function setupSocket() {
        try {
          // io() connects to same origin by default
          const socket = io();

          socket.on('connect', () => {
            console.log('Socket.IO connected:', socket.id);
            socket.emit('request_latest_attacks');
          });

          socket.on('status', (d) => console.log('WS status:', d));

          socket.on('latest_attacks', (list) => {
            console.log('latest_attacks', list);
            attacksCache = list;
            renderTimeline(list);
            updateSummaryAndCharts(list);
          });

          socket.on('new_attack', (attack) => {
            console.log('new_attack', attack);
            // prepend to cache and update minimal UI immediately
            attacksCache.unshift(attack);
            renderTimeline(attacksCache);
            updateSummaryAndCharts(attacksCache);
            flashToast('New attack: ' + (attack.path || attack.method || attack.source_ip || 'unknown'));
          });

          socket.on('attack_enriched', (attack) => {
            console.log('attack_enriched', attack);
            const idx = attacksCache.findIndex(a => Number(a.id) === Number(attack.id));
            if (idx !== -1) attacksCache[idx] = attack;
            else attacksCache.unshift(attack);
            renderTimeline(attacksCache);
            updateSummaryAndCharts(attacksCache);
          });

          socket.on('connect_error', (err) => {
            console.warn('socket connect_error', err);
            flashToast('Realtime connection issue — check server/proxy', true);
          });
        } catch (err) {
          console.error('setupSocket error', err);
        }
      }

      // Chart detail modal (re-usable)
      function showChartDetails(title, subtitle) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.setAttribute('role','dialog');
        modal.innerHTML = `
          <div class="bg-[#1b2824] rounded-xl border border-[#39564d] p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-white text-xl font-bold">${escapeHtml(title)}</h2>
              <button class="close-modal text-[#9abcb1] hover:text-white text-2xl">&times;</button>
            </div>
            <div class="text-[#9abcb1]">
              <h3 class="text-white font-medium mb-2">${escapeHtml(subtitle)}</h3>
              <p class="text-sm">Detailed breakdown (live data)</p>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        const close = () => { modal.remove(); document.removeEventListener('keydown', onKey); };
        modal.addEventListener('click', (e) => { if (e.target === modal || e.target.classList.contains('close-modal')) close(); });
        function onKey(e) { if (e.key === 'Escape') close(); }
        document.addEventListener('keydown', onKey);
      }

      // Click handlers for chart-interactive elements (keeps compatibility with your previous data-* triggers)
      document.addEventListener('click', (e) => {
        if (e.target.dataset.attackType) {
          showChartDetails('Attack Type', e.target.dataset.attackType);
        } else if (e.target.dataset.country) {
          showChartDetails('Country Analysis', e.target.dataset.country);
        }
      });

      // Time-range selector (keeps previous behavior, triggers re-fetch)
      document.getElementById('time-range').addEventListener('change', function() {
        const range = this.value;
        flashToast(`Report updated for ${range.replace('d',' days').replace('h',' hours')}`);
        // in future you might pass this value to the API; for now we just refetch and re-render
        fetchAndRender();
      });

      // Export functionality (unchanged)
      document.getElementById('export-report').addEventListener('click', function() {
        const btn = this;
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<span>Exporting...</span>';
        btn.disabled = true;

        setTimeout(() => {
          btn.innerHTML = '<span>✓ Exported</span>';
          btn.classList.add('bg-green-600');

          const reportData = {
            generatedAt: new Date().toISOString(),
            summary: {
              threatLevel: document.getElementById('threat-level').textContent,
              blockedAttacks: document.getElementById('blocked-attacks-total').textContent,
              activeThreats: document.getElementById('active-threats-total').textContent,
              systemHealth: document.getElementById('system-health-total').textContent
            }
          };

          const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `iot-security-report-${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.classList.remove('bg-green-600');
            btn.disabled = false;
          }, 1200);
        }, 800);
      });

      // Initialize charts & data
      fetchAndRender().then(() => {
        setupSocket();
      }).catch(() => {
        // still try to connect sockets even if initial fetch failed
        setupSocket();
      });
    });
  </script>
</body>
</html>
